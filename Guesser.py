
from flask import Flask, render_template, request, url_for, redirect
from deck_manager import *


app = Flask(__name__)


# Routing. Move to different module?
@app.route("/")
@app.route("/index/")
def index():
    """Starting page. Doesn't take any arguments (yet?)"""

    return render_template(
        "index.html",
        deck_count=len(load_database()),
        total_cards=total_cards(),
        total_due=total_due(),
        )


@app.route("/browse/")
def browse():
    """Displays a list of decks in the app.

    Context Args:
        deck_names (list): List of deck name strings.
    """

    cards_per_deck = {}
    for deck_name in list_decks():
        cards_per_deck[deck_name] = total_cards(deck_name)
    return render_template(
        "browse/select_deck.html", 
        select_mode = "browse",
        deck_names = list_decks(),
        cards_per_deck = cards_per_deck,
        )


@app.route("/browse/<deck_name>/", methods=["GET", "POST"])
def browse_deck(deck_name: str):
    """Displays a table of all entries in a selected deck.

    Takes only GET requests so far.

    Args:
        deck_name (str): Name of deck.
    
    Context Args:
        deck (dict): Dictionary containing deck data and information.
    """
    if request.method == "GET":
        return render_template("browse/deck.html", 
                                deck_name=deck_name,
                                deck=load_database()[deck_name])

    if request.method == "POST":
        update_card(deck_name, request.form)
        return redirect(url_for("browse_deck", deck_name=deck_name))


@app.route("/browse/<deck_name>/<card_id>/", methods=["GET", "POST"])
def edit_item(deck_name: str, card_id: str):
    """
    View a single entry in deck.
    ┌=========================┐
    |PLEASE REWRITE THIS LATER|
    └=========================┘
    Right now it's not a separate view but a sub-view tied to the browse_deck
    function.

    GET: Opens an editing interface for a card selected by ID.
    Loads language data and card data from deck.
    Currently it only lets you edit the key value pairs.

    POST: Updates a value.
    
    Args:
        deck_name (str): Name of deck.
        card_id (str): The id of a card.
    
    Context Args:
        languages (list): List of strings representing the data keys.
        card (dict): Card data to fill all the cells.
        deck_name (str): Name of deck.
    """

    # if request.method == "GET":
    #     return render_template(
    #         "browse/item.html",
    #         deck_name=deck_name,
    #         languages=get_languages(deck_name),
    #         card=get_card(card_id, deck_name),
    #         )
    
    # maybe make it another function?
    if request.method == "POST":
        update_card(deck_name, request.form)
        return redirect(url_for("browse_deck", deck_name=deck_name))


@app.route("/add/<deck_name>/", methods=["POST", "GET"])
def add_item(deck_name: str):
    """ Brings up the interface to add a new item to the selected deck.

        Args:
            deck_name (str): deck name string.
        Context Args:
            languages (str): languages for headers.
    """

    if request.method == "POST":
        add_card(deck_name, request.form)
        return redirect(url_for("browse_deck", deck_name=deck_name))


@app.route("/train/")
def train():
    """Lists user decks available for training.

    Args:
        deck_names (list): List with string names of all available decks.
    """
    deck_stats = {}
    for deck_name in list_decks():
        deck_stats[deck_name] = {}
        for front in get_languages(deck_name):
            deck_stats[deck_name][front] = {}
            deck_stats[deck_name][front]["due_number"] = \
                count_due(deck_name, front)
            deck_stats[deck_name][front]["next_due"] = \
                get_next_card_due(deck_name, front)

    return render_template(
        "train/choose_deck.html",
        deck_stats=deck_stats
        )


@app.route("/train/<deck_name>/<front>", methods=["GET", "POST"])
def train_deck(deck_name: str, front: str):
    """Actual training interface. 
    
    Course of actions:
        1. Get the due cards. If no due cards are up: redirects to new card
        adding interface.
        2. Pick one card from the due deck and generate the training page.
        ^ subject to change.
        3. The training page shows you the front card, you need to
        remember the end card. That's about it.
        Then it shows you the right answer, and based on your response
        (button pressed), resets the card's timer values or increments it.

    Possible modifications: multiple choice buttons. 
    Or entry field, though I'm not sure.

    Args:
        deck_name (str): deck name string.
        front (str): front card language.
    Context Args:
        Maybe rewrite that?
    card: card object with front and back attributes, generated by fn.
    """    
    if request.method == "GET":
        due_deck = get_due(deck_name, front)
        if due_deck["cards"] == []:
            return redirect(url_for(
                "new_cards", 
                deck_name=deck_name, 
                front=front))
        else:
            card = pick_card(due_deck, front=front)
            return render_template(
                "train/train.html",
                card=card,
                deck_name=deck_name,
                front=front,
                due_cards = len(due_deck["cards"])
                )
    if request.method == "POST":
        update_date(
            deck_name=deck_name, 
            card_id=request.form["card_id"],
            front=front,
            method=request.form["action"])
        return redirect(url_for(
            "train_deck", 
            deck_name=deck_name, 
            front=front
            ))


@app.route("/new/<deck_name>/<front>", methods=["POST", "GET"])
def new_cards(deck_name: str, front: str):
    """An interface for adding new due cards to the deck.
    
    Subject for rewriting. 

    Args:
        deck_name (str): Deck name.
        front (str): Front language.

    Context args:
        result (str): Either "Done" or "Empty".
    """
    if request.method == "GET":
        return render_template(
            "new/cards.html", 
            deck_name=deck_name, 
            front=front
            )
    if request.method == "POST":
        languages = load_database()[deck_name]["languages"]
        deck = create_learn_deck(deck_name, get_next_id(deck_name, 1))
        if request.form["new card"] == "yes":
            if deck["cards"] == []:
                return render_template("new/oops.html", deck_name=deck_name)
            else:
                return render_template(
                    "new/added_card.html",
                    deck=deck, 
                    deck_name=deck_name)
        if request.form["new card"] == "learn":
            for card_id in get_next_id(deck_name, 1):
                set_both_due(deck_name, card_id)
            return redirect(
                url_for("train_deck", deck_name=deck_name, front=front))


# Start frontend
if __name__ == "__main__":
    app.secret_key = "test"
    app.run(debug=True)
